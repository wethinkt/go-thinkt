# thinkt-exporter Dockerfile
# Lightweight image for the trace exporter daemon.
# Copyright (c) 2026 Neomantra Corp / BrainSTM

ARG THINKT_BUILD_BASE="golang"
ARG THINKT_BUILD_TAG="1.25-bookworm"

ARG THINKT_RUNTIME_BASE="debian"
ARG THINKT_RUNTIME_TAG="bookworm-slim"

###############################################################################
# Builder
###############################################################################

FROM ${THINKT_BUILD_BASE}:${THINKT_BUILD_TAG} AS build

ARG TARGETARCH

ADD . /src
WORKDIR /src

RUN CGO_ENABLED=0 go build -ldflags="-s -w" -o bin/thinkt-exporter ./cmd/thinkt-exporter

###############################################################################
# Runtime
###############################################################################

FROM ${THINKT_RUNTIME_BASE}:${THINKT_RUNTIME_TAG} AS runtime

ARG THINKT_BUILD_BASE="golang"
ARG THINKT_BUILD_TAG="1.25-bookworm"
ARG THINKT_RUNTIME_BASE="debian"
ARG THINKT_RUNTIME_TAG="bookworm-slim"
ARG TARGETARCH

RUN DEBIAN_FRONTEND=noninteractive apt-get update \
    && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        ca-certificates \
    && rm -rf /var/lib/apt/lists/* \
    && useradd -m -d /data -u 5454 thinkt

COPY --from=build /src/bin/thinkt-exporter /usr/local/bin/thinkt-exporter

USER thinkt
WORKDIR /data

# Labels
LABEL org.opencontainers.image.title="thinkt-exporter"
LABEL org.opencontainers.image.description="Exports LLM conversation traces to thinkt"
LABEL THINKT_BUILD_BASE="${THINKT_BUILD_BASE}"
LABEL THINKT_BUILD_TAG="${THINKT_BUILD_TAG}"
LABEL THINKT_RUNTIME_BASE="${THINKT_RUNTIME_BASE}"
LABEL THINKT_RUNTIME_TAG="${THINKT_RUNTIME_TAG}"
LABEL THINKT_TARGET_ARCH="${TARGETARCH}"

ENTRYPOINT ["/usr/local/bin/thinkt-exporter"]
