# PLAN: thinkt-claude-prompts

Implementation plan for the `thinkt-claude-prompts` CLI tool.

## Goal

Extract user prompts from Claude Code trace files (JSONL) and generate a `PROMPTS.md` file with ISO 8601 timestamps.

## Context

- **Existing**: Hook-based real-time logging (`.claude/hooks/prompt-history.sh`)
- **New Tool**: Batch extraction from existing trace files
- **Use Case**: Reconstruct prompt history from past sessions or when hooks weren't enabled

## Architecture

```
cmd/
  thinkt-claude-prompts/
    main.go              # CLI entry point
internal/
  trace/
    parser.go            # JSONL parsing
    types.go             # Message/trace types
  prompt/
    extractor.go         # Prompt extraction logic
    formatter.go         # Markdown output formatting
```

## Implementation Phases

### Phase 1: Project Scaffolding

- [ ] Initialize Go module (`go mod init github.com/Brain-STM-org/thinking-tracer-tools`)
- [ ] Create `Taskfile.yml` with build/test/lint tasks
- [ ] Add `.gitignore` for Go binaries
- [ ] Create directory structure

### Phase 2: Trace Parsing

- [ ] Define types for Claude Code JSONL format
  - Message structure (role, content, timestamp)
  - Content block types (text, tool_use, tool_result, thinking)
- [ ] Implement JSONL line-by-line parser
- [ ] Handle streaming/large files efficiently
- [ ] Add test fixtures from sample traces

### Phase 3: Prompt Extraction

- [ ] Filter messages by `role: "user"`
- [ ] Extract text content from user messages
- [ ] Parse timestamps from message metadata
- [ ] Handle multi-part user messages

### Phase 4: Markdown Generation

- [ ] Format output matching existing `PROMPTS.md` structure:
  ```markdown
  ---

  ## 2026-01-24T20:41:03Z

  <prompt text>
  ```
- [ ] Support append vs overwrite modes
- [ ] Add header/footer options (optional)

### Phase 5: CLI Interface

- [ ] Parse command-line flags:
  - `--input, -i` : Input JSONL file (required)
  - `--output, -o` : Output file (default: `PROMPTS.md`)
  - `--append, -a` : Append to existing file
  - `--format, -f` : Output format (markdown, json, plain)
- [ ] Auto-detect latest trace file in `~/.claude/projects/`
- [ ] Support stdin/stdout for piping

### Phase 6: Testing & Polish

- [ ] Unit tests for parser, extractor, formatter
- [ ] Integration test with real trace file
- [ ] Error handling and user-friendly messages
- [ ] README usage examples

## Claude Code JSONL Format

Based on trace analysis, messages follow this structure:

```jsonl
{"type":"message","role":"user","content":[{"type":"text","text":"..."}],"timestamp":"..."}
{"type":"message","role":"assistant","content":[{"type":"thinking","thinking":"..."},{"type":"text","text":"..."},{"type":"tool_use","name":"...","input":{...}}],"timestamp":"..."}
```

Key fields for prompt extraction:
- `role`: Filter for `"user"`
- `content[].type`: Look for `"text"` blocks
- `content[].text`: The actual prompt text
- `timestamp`: ISO 8601 format (may need parsing from various formats)

## Taskfile.yml

```yaml
version: '3'

vars:
  BINARY: thinkt-claude-prompts
  CMD_DIR: ./cmd/thinkt-claude-prompts

tasks:
  build:
    desc: Build the CLI binary
    cmds:
      - go build -o bin/{{.BINARY}} {{.CMD_DIR}}

  test:
    desc: Run tests
    cmds:
      - go test ./...

  lint:
    desc: Run linter
    cmds:
      - golangci-lint run

  install:
    desc: Install to GOPATH/bin
    cmds:
      - go install {{.CMD_DIR}}

  clean:
    desc: Remove build artifacts
    cmds:
      - rm -rf bin/
```

## Success Criteria

1. `thinkt-claude-prompts -i trace.jsonl` produces valid `PROMPTS.md`
2. Output matches format generated by existing hook
3. Handles traces with 1000+ turns without memory issues
4. Clear error messages for malformed input

## Future Enhancements

- Support for other agent trace formats (Cursor, Aider, etc.)
- Filtering by date range
- Search/grep within prompts
- Statistics output (prompt count, avg length, etc.)
